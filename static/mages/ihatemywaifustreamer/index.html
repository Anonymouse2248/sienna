<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>I Hate My Waifu Streamer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json" crossorigin="use-credentials" />
  <meta name="theme-color" content="#000" />

  <style>
    html { background: #444; font-family: sans-serif; }
    body, html { overscroll-behavior: none; }
    #canvas, #overlayDiv { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
    #canvas { background: #000; }
    .visible { visibility: visible; opacity: 1; transition: opacity .1s linear; }
    .hidden { visibility: hidden; opacity: 0; transition: visibility 0s .25s, opacity .25s linear; }
    #statusDiv, #inputDiv {
      background: rgba(0, 0, 0, 0.75);
      width: 50%; margin: auto; min-width: 340px; padding: 10px;
      position: absolute; top: 0; left: 0; right: 0; border-radius: 0 0 5px 5px;
    }
    #statusTextDiv { overflow: auto; max-height: 40vh; color: #ccc; font-size: 14px; }
    #statusProgress { display: none; width: 100%; }
    #inputDiv { width: 65%; padding: 0 20px 0 10px; }
    #inputPrompt { color: #eee; font-size: 150%; margin: 1em 0; }
    #inputText { width: 100%; font-size: 175%; padding: 5px; background: inherit; color: #eee; }
    #inputText:focus { color: #fff; }
    #ContextContainer { position: absolute; left: 0; top: 0; color: white; }
    #ContextContainer.shown { background: rgba(0,0,0,0.5); border-radius: 0 0 5px 0; }
    #ContextButton { text-decoration: none; color: lightgrey; font-size: xx-large; cursor: pointer; user-select: none; padding: 10px; opacity: .75; }
    #ContextButton:focus { outline: none; color: #fff; opacity: 1; }
    #ContextMenu a {
      text-decoration: none; color: lightgrey; background: #444;
      height: 48px; width: 250px; border-radius: 5px; border: 1px solid lightgrey;
      display: flex; align-items: center; justify-content: center; margin: 5px; opacity: 1;
    }
    #ContextMenu a:hover { background: #666; color: #fff; }
    #presplash {
      position: absolute; top: 0; left: 0; display: block;
      width: 100%; height: 100%; object-fit: contain;
    }
  </style>
</head>
<body>
  <canvas id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>
  <div id="overlayDiv"></div>
  <img id="presplash" src="web-presplash.jpg">

  <div id="ContextContainer">
    <a id="ContextButton">&#8801;</a><br />
    <div id="ContextMenu" style="display: none;">
      <input id="ID_SavegamesImport" type="file" onchange="onSavegamesImport(this)" accept="application/zip" style="display:none;">
      <a href="javascript:document.getElementById('ID_SavegamesImport').click();">Import Saves</a>
      <a href="javascript:onSavegamesExport();">Export Saves</a>
      <a href="javascript:FSDownload('/log.txt','text/plain');">Download Log</a>
      <a href="https://www.renpy.org/" target="_blank">Powered by Ren'Py</a>
    </div>
  </div>

  <div id="statusDiv" class="hidden">
    <div id="statusTextDiv"></div>
    <progress id="statusProgress" value="0" max="100"></progress>
  </div>

  <div id="inputDiv" class="hidden">
    <form id="inputForm">
      <div id="inputPrompt"></div>
      <input id="inputText" type="text">
    </form>
  </div>

  <script>
    async function loadGameFiles() {
      // JSDelivr CDN-only approach
      const base = "https://cdn.jsdelivr.net/gh/yellowdevelopmnt/jsdelivr-cdns/ihatemywaifustreamer/";
      const partCount = 8;
      const partFiles = Array.from({ length: partCount }, (_, i) => `${base}game.zip.part${i + 1}`);
      
      console.log("üîÑ Loading game parts from JSDelivr CDN (latest)...");
      console.log("üì¶ Base URL:", base);
      
      // Fetch all parts
      const responses = await Promise.all(
        partFiles.map(async (url, index) => {
          console.log(`ÔøΩ Fetching part ${index + 1}: ${url}`);
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`Failed to fetch part ${index + 1} from ${url} (Status: ${response.status} ${response.statusText})`);
          }
          console.log(`‚úÖ Part ${index + 1} loaded successfully (${response.headers.get('content-length')} bytes)`);
          return response.arrayBuffer();
        })
      );
      
      console.log("ÔøΩ Combining all parts...");
      
      // Combine all binary parts
      const totalSize = responses.reduce((sum, buf) => sum + buf.byteLength, 0);
      console.log(`üìä Total size: ${totalSize} bytes (${(totalSize / 1024 / 1024).toFixed(2)} MB)`);
      
      const merged = new Uint8Array(totalSize);
      let offset = 0;
      for (const buf of responses) {
        merged.set(new Uint8Array(buf), offset);
        offset += buf.byteLength;
      }
      
      // Create Blob for Ren'Py
      const blob = new Blob([merged], { type: "application/zip" });
      const zipURL = URL.createObjectURL(blob);
      console.log("‚úÖ Game ZIP ready:", zipURL);
      return zipURL;
    }

    (async () => {
      try {
        const combinedZip = await loadGameFiles();
        window.gameZipURL = combinedZip; // Use this instead of local game.zip

        // Register Service Worker
        if (navigator.serviceWorker && !navigator.serviceWorker.controller) {
          navigator.serviceWorker.register('./service-worker.js', { updateViaCache: 'all' });
        }

        // Dynamically load Ren'Py engine
        const script = document.createElement("script");
        script.src = "renpy-pre.js";
        script.onload = () => {
          const mainScript = document.createElement("script");
          mainScript.src = "renpy.js";
          mainScript.async = true;
          document.body.appendChild(mainScript);
        };
        document.body.appendChild(script);
      } catch (err) {
        console.error("‚ùå Error loading game:", err);
        
        // Show detailed error message
        const errorDiv = document.getElementById("statusTextDiv");
        errorDiv.innerHTML = `
          <h3>Failed to load game files from JSDelivr CDN</h3>
          <p><strong>Error:</strong> ${err.message}</p>
          <p><strong>CDN URL:</strong><br>
          <code>https://cdn.jsdelivr.net/gh/yellowdevelopmnt/jsdelivr-cdns/ihatemywaifustreamer/</code></p>
          <p><strong>Expected files:</strong> game.zip.part1 through game.zip.part8</p>
          <p><strong>Troubleshooting:</strong></p>
          <ol>
            <li>Check that all 8 part files exist in your GitHub repository</li>
            <li>Verify the repository is public</li>
            <li>JSDelivr may need time to index your repository (usually 15-30 minutes)</li>
            <li>Try accessing the files directly: <a href="https://cdn.jsdelivr.net/gh/yellowdevelopmnt/jsdelivr-cdns/ihatemywaifustreamer/game.zip.part1" target="_blank">game.zip.part1</a></li>
          </ol>
          <p><em>Repository confirmed at: <a href="https://github.com/yellowdevelopmnt/jsdelivr-cdns/tree/main/ihatemywaifustreamer" target="_blank">GitHub</a></em></p>
        `;
        document.getElementById("statusDiv").classList.remove("hidden");
      }
    })();
  </script>
</body>
</html>
